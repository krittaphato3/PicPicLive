<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicPicLive - Pinnacle Edition v2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 20, 0.85);
            --accent: #3b82f6;
            --danger: #ef4444;
            --text: #ffffff;
            --sidebar-width: 320px;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); overflow: hidden;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; 
            color: var(--text);
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Ambient Background Layer --- */
        #ambient-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0; transition: opacity 0.8s ease;
            background-size: cover; background-position: center;
            filter: blur(60px) brightness(0.4);
            transform: scale(1.2); /* Prevent blur edges */
            pointer-events: none;
        }

        /* --- Navigation Zones --- */
        .nav-zone {
            position: absolute; top: 0; height: 100%; z-index: 150;
            cursor: pointer; display: none;
        }
        #nav-left { left: 0; width: 20%; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent); opacity: 0; transition: opacity 0.3s; }
        #nav-right { right: 0; width: 20%; background: linear-gradient(to left, rgba(0,0,0,0.1), transparent); opacity: 0; transition: opacity 0.3s; }
        #nav-center { left: 20%; width: 60%; cursor: default; } 
        .nav-zone:hover { opacity: 1; }

        /* --- Modal System --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        #modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: #1a1a1a; border: 1px solid #333; width: 350px;
            border-radius: 20px; padding: 30px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #modal-overlay.active .modal-box { transform: scale(1); }

        .modal-icon { font-size: 3rem; color: var(--danger); margin-bottom: 20px; }
        .modal-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 10px; color: #fff; }
        .modal-desc { font-size: 0.95rem; color: #bbb; margin-bottom: 30px; line-height: 1.5; }
        
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .modal-btn {
            border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer;
            font-weight: 600; font-size: 0.95rem; transition: 0.2s;
        }
        .btn-cancel { background: #2a2a2a; color: #ccc; }
        .btn-cancel:hover { background: #3a3a3a; color: #fff; }
        .btn-confirm { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-confirm:hover { background: #dc2626; transform: translateY(-2px); }

        /* --- Settings Panel (Control Center) --- */
        #settings-panel {
            position: fixed; bottom: 100px; right: 20px;
            width: 320px; background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 20px;
            z-index: 600; transform: translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 15px;
        }
        #settings-panel.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .settings-header h3 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        
        .setting-group { display: flex; flex-direction: column; gap: 8px; }
        .setting-title { font-size: 0.75rem; color: var(--accent); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-top: 5px; }
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #ddd; }
        
        /* Custom Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- Landing / Upload Zone --- */
        #upload-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 100; background-color: #080808; 
            transition: opacity 0.4s ease;
            overflow-y: auto; padding-top: 40px; box-sizing: border-box;
        }
        #upload-zone.hidden { display: none; }
        
        .landing-section { width: 90%; max-width: 1200px; margin-bottom: 50px; animation: fadeIn 0.8s ease-out; }
        
        .upload-content { 
            text-align: center; padding: 40px; 
            border: 1px dashed #333; border-radius: 20px; 
            background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
        }
        .upload-content:hover { border-color: #555; }
        .upload-content i.main-icon { font-size: 3.5rem; margin-bottom: 15px; color: #444; }
        .upload-options { display: flex; gap: 20px; margin-top: 25px; justify-content: center; flex-wrap: wrap;}
        .up-btn {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 12px 25px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
            font-size: 0.95rem; font-weight: 500;
        }
        .up-btn:hover { background: #333; border-color: #666; transform: translateY(-2px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        #landing-header {
            display: flex; align-items: center; gap: 12px;
            color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 25px; border-bottom: 1px solid #222; padding-bottom: 15px; font-weight: 600;
        }
        #landing-grid { display: flex; flex-wrap: wrap; gap: 25px; }
        
        .landing-card {
            width: 260px; height: 240px;
            background: #151515; border: 1px solid #222; border-radius: 12px;
            overflow: hidden; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; position: relative;
        }
        .landing-card:hover { transform: translateY(-8px) scale(1.02); border-color: var(--accent); box-shadow: 0 15px 40px rgba(0,0,0,0.6); z-index: 10; }
        
        /* --- Viewer --- */
        #viewer {
            position: relative; width: 100%; height: 100vh;
            display: none; justify-content: center; align-items: center;
            overflow: hidden; 
            cursor: grab;
        }
        #viewer:active { cursor: grabbing; }

        .frame-display {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            transition: filter 0.5s ease;
            pointer-events: none; 
            transform-origin: center center;
            z-index: 2; /* Above Ambient BG */
        }
        #img-back { z-index: 2; }
        #img-front { z-index: 3; }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 200;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 40px;
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #ui-layer.hidden { opacity: 0; transform: translateY(20px); }
        #ui-layer > * { pointer-events: auto; }

        /* --- Filmstrip --- */
        #filmstrip {
            display: flex; gap: 10px; padding: 12px 16px;
            background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(15px);
            border-radius: 16px; margin-bottom: 20px;
            overflow-x: auto; max-width: 80vw; scrollbar-width: none;
            border: 1px solid rgba(255,255,255,0.05);
        }
        #filmstrip::-webkit-scrollbar { display: none; }
        
        .thumb-wrap {
            position: relative; width: 56px; height: 56px; flex-shrink: 0;
            border-radius: 8px; overflow: hidden;
            cursor: pointer; transition: 0.2s; background: #222; opacity: 0.5;
            border: 2px solid transparent;
        }
        .thumb-wrap:hover { opacity: 0.8; transform: translateY(-2px); }
        .thumb-wrap.active { border-color: var(--accent); opacity: 1; transform: scale(1.1); box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- Controls Bar --- */
        #controls {
            background-color: var(--panel-bg); backdrop-filter: blur(25px);
            padding: 10px 30px; border-radius: 50px;
            display: flex; gap: 18px; align-items: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: 90vw; overflow-x: auto;
        }
        button.ctrl-btn { 
            background: transparent; border: none; color: #aaa; 
            font-size: 1.1rem; cursor: pointer; width: 44px; height: 44px; 
            border-radius: 50%; transition: all 0.2s ease; flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center;
        }
        button.ctrl-btn:hover { color: #fff; background: rgba(255,255,255,0.1); transform: translateY(-3px); }
        button.ctrl-btn.active-btn { color: var(--accent); background: rgba(59, 130, 246, 0.15); }
        
        /* --- Sidebar --- */
        #preset-bar {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: rgba(12, 12, 12, 0.98); backdrop-filter: blur(20px);
            z-index: 300; transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            border-right: 1px solid #2a2a2a; display: flex; flex-direction: column;
            padding: 25px; box-sizing: border-box; box-shadow: 10px 0 50px rgba(0,0,0,0.5);
        }
        #preset-bar.open { transform: translateX(0); }
        
        .sidebar-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h3 { margin: 0; font-weight: 400; letter-spacing: 1px; font-size: 1.4rem; color: #fff;}
        
        #preset-search {
            width: 100%; padding: 12px 15px; background: #1a1a1a; border: 1px solid #333;
            color: #fff; border-radius: 10px; box-sizing: border-box; outline: none;
            font-size: 0.95rem; margin-bottom: 20px;
        }
        #preset-search:focus { border-color: var(--accent); background: #222; }

        #preset-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; scrollbar-width: thin; }
        
        .album-card {
            background: #151515; border-radius: 10px; overflow: hidden;
            border: 1px solid #333; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; position: relative;
            min-height: 80px; 
        }
        .album-card:hover { border-color: #555; background: #222; }
        .album-card.active { border-color: var(--accent); background: #1a1e25; }
        
        .album-delete-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0, 0.7); color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; 
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: 0.2s; z-index: 50; 
            backdrop-filter: blur(4px);
        }
        .album-card:hover .album-delete-btn, .landing-card:hover .album-delete-btn { opacity: 1; }
        .album-delete-btn:hover { background: #ef4444; color: white; transform: scale(1.1); }

        .album-grid { 
            width: 100%; height: 160px;
            display: grid; gap: 1px; background: #000; flex-shrink: 0; 
        }
        .album-grid.layout-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .album-grid.layout-1 { grid-template-columns: 1fr; grid-template-rows: 1fr; }
        .album-grid.layout-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        .album-grid.layout-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .album-grid.layout-3 img:first-child { grid-column: span 2; }
        
        .album-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0.85; transition: opacity 0.2s; }
        .album-card:hover .album-thumb { opacity: 1; }
        
        .album-more-wrap { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .album-more-wrap img { width: 100%; height: 100%; object-fit: cover; filter: blur(4px); transform: scale(1.1); }
        .album-remaining {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); color: #fff; font-weight: 700; font-size: 1.1rem;
        }

        .album-info { 
            padding: 12px 15px; background: #1a1a1a; border-top: 1px solid #2a2a2a; 
            display: flex; flex-direction: column; justify-content: center; gap: 4px; 
            flex-grow: 1; height: 100%;
        }
        .album-name { font-size: 0.95rem; font-weight: 600; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .album-meta { display: flex; justify-content: space-between; width: 100%; font-size: 0.75rem; color: #666; }

        /* --- Floating Top Buttons --- */
        #btn-presets-toggle {
            position: fixed; top: 25px; left: 25px; z-index: 301;
            background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid rgba(255,255,255,0.1);
            width: 45px; height: 45px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        #btn-presets-toggle:hover { color: #fff; background: rgba(255,255,255,0.15); transform: scale(1.05); }

        #btn-home {
            position: fixed; top: 25px; right: 25px; z-index: 301;
            background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid rgba(255,255,255,0.1);
            width: 45px; height: 45px; border-radius: 12px; cursor: pointer;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }
        #btn-home:hover { color: #fff; background: rgba(220, 38, 38, 0.4); border-color: rgba(220, 38, 38, 0.6); transform: scale(1.05); }

        /* --- Grid Inventory --- */
        #grid-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--grid-bg); z-index: 400;
            display: none; flex-direction: column; padding: 30px 50px; box-sizing: border-box;
            backdrop-filter: blur(20px);
        }
        #grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        #grid-header span { font-size: 2rem; font-weight: 300; letter-spacing: 1px; color: #eee; }
        #grid-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; overflow-y: auto; flex: 1; padding-bottom: 50px; }
        .grid-item { position: relative; aspect-ratio: 1; border-radius: 10px; overflow: hidden; background: #1a1a1a; cursor: pointer; transition: transform 0.2s ease; }
        .grid-item:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 5; }
        .grid-item.active { outline: 3px solid var(--accent); outline-offset: -3px; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        .grid-delete {
            position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.7); color: #fff;
            border: none; border-radius: 6px; padding: 6px; cursor: pointer; opacity: 0; transition: 0.2s;
        }
        .grid-item:hover .grid-delete { opacity: 1; }

        /* --- Toast --- */
        #toast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(15,15,15,0.9); color: white; padding: 16px 32px; 
            border-radius: 50px; font-size: 1.1rem; pointer-events: none; opacity: 0; 
            transition: opacity 0.3s; z-index: 500; backdrop-filter: blur(10px); 
            border: 1px solid #333; box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }

        /* --- Range Slider --- */
        .slider-group { display: flex; flex-direction: column; align-items: center; width: 120px; flex-shrink: 0; margin: 0 5px; }
        .slider-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 6px; }
        .slider-label { font-size: 0.6rem; color: #777; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;}
        .slider-val { font-size: 0.6rem; color: var(--accent); font-family: monospace; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; appearance: none; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-box">
            <i class="fas fa-exclamation-triangle modal-icon"></i>
            <div class="modal-title" id="modal-title">Confirm Action</div>
            <div class="modal-desc" id="modal-desc">Are you sure?</div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <canvas id="pip-canvas" style="display:none;"></canvas>
    <video id="pip-video" style="display:none;" muted autoplay playsinline></video>
    <canvas id="analysis-canvas" style="display:none;"></canvas>

    <button id="btn-presets-toggle" onclick="toggleSidebar()" title="Open Library"><i class="fas fa-folder"></i></button>
    <div id="preset-bar">
        <div class="sidebar-header">
            <h3>Library</h3>
            <button class="ctrl-btn" onclick="toggleSidebar()" style="font-size:1rem; width:36px; height:36px;"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <input type="text" id="preset-search" placeholder="Search albums..." onkeyup="filterPresets()">
        
        <div id="preset-list"></div>
        
        <div style="margin-top:auto; display:flex; flex-direction:column; gap:12px;">
            <button id="add-folder-btn" onclick="document.getElementById('folder-input').click()" class="up-btn">
                <i class="fas fa-plus"></i> Import New Folder
            </button>
        </div>
    </div>

    <button id="btn-home" onclick="goHome()" title="Back to Main Menu (Esc)"><i class="fas fa-home"></i></button>

    <div id="upload-zone">
        <div class="landing-section upload-content">
            <i class="fas fa-cloud-upload-alt main-icon"></i>
            <h2 style="font-weight: 300; margin: 0 0 10px 0; color: #fff;">Import Media</h2>
            <p style="color:#666; font-size: 0.9rem; margin-bottom: 25px;">Files are stored locally. No server upload.</p>
            <div class="upload-options">
                <button class="up-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-images"></i> Select Images
                </button>
                <button class="up-btn" onclick="document.getElementById('folder-input').click()">
                    <i class="fas fa-folder-open"></i> Import Folder
                </button>
            </div>
        </div>

        <div class="landing-section" id="landing-grid-container">
            <div id="landing-header">
                <i class="fas fa-compact-disc"></i> <span>Detected Albums</span>
            </div>
            <div id="landing-grid">
                <p id="scan-status" style="color:#555; font-size:1rem;">Accessing Local Storage...</p>
            </div>
        </div>

        <input type="file" id="file-input" accept="image/*" multiple style="display:none">
        <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none">
    </div>

    <div id="viewer">
        <div id="ambient-bg"></div>
        
        <div id="nav-left" class="nav-zone" onclick="prevSlide()" title="Previous"></div>
        <div id="nav-center" class="nav-zone" title="Drag to Pan / Click for UI"></div>
        <div id="nav-right" class="nav-zone" onclick="nextSlide()" title="Next"></div>

        <img id="img-back" class="frame-display" src="">
        <img id="img-front" class="frame-display" src="">
    </div>

    <div id="settings-panel">
        <div class="settings-header">
            <h3>Control Center</h3>
            <button class="ctrl-btn" onclick="toggleSettings()" style="width:32px; height:32px; font-size:0.9rem;"><i class="fas fa-times"></i></button>
        </div>

        <div class="setting-title">Picture-in-Picture</div>
        <div class="setting-group">
            <div class="setting-row">
                <span>Aspect Ratio</span>
                <button class="up-btn" id="pip-ratio-btn" onclick="cyclePiPRatio()" style="padding: 4px 10px; font-size:0.8rem;">Fit</button>
            </div>
            <div class="setting-row">
                <span>Sync Zoom</span>
                <label class="switch"><input type="checkbox" id="pip-sync-check" onchange="updatePiPSettings()" checked><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Show Info</span>
                <label class="switch"><input type="checkbox" id="pip-info-check" onchange="updatePiPSettings()"><span class="slider"></span></label>
            </div>
        </div>

        <div class="setting-title">Main Player</div>
        <div class="setting-group">
            <div class="setting-row">
                <span>Ambient Background</span>
                <label class="switch"><input type="checkbox" id="ambient-check" onchange="toggleAmbient()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Scale Mode</span>
                <button class="up-btn" id="scale-mode-btn" onclick="toggleScaleMode()" style="padding: 4px 10px; font-size:0.8rem;">Fit</button>
            </div>
            <div class="setting-group">
                 <div class="setting-row" style="margin-top:5px;">
                     <span>Remote Zoom</span>
                     <span class="slider-val" id="zoom-val">100%</span>
                 </div>
                 <input type="range" id="master-zoom" min="100" max="500" value="100" step="10" oninput="manualZoom(this.value)">
            </div>
        </div>

        <div class="setting-title">System</div>
        <div class="setting-group">
            <button onclick="askClearDB()" class="up-btn" style="width:100%; justify-content:center; background:#3f1010; border-color:#501010; color:#ef4444;">
                <i class="fas fa-trash"></i> Clear Database
            </button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="filmstrip"></div>

        <div id="controls">
            <button class="ctrl-btn" id="btn-play" onclick="togglePlay()" title="Play/Pause (Space)"><i class="fas fa-play"></i></button>
            
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Speed</span>
                    <span class="slider-val" id="speed-val">3.0s</span>
                </div>
                <input type="range" id="speed-slider" min="100" max="10000" step="100" value="3000">
            </div>

            <div style="width:1px; height:24px; background:rgba(255,255,255,0.1);"></div>

            <button class="ctrl-btn" id="btn-effect" onclick="cycleEffect()" title="Transition Effect"><i class="fas fa-magic"></i></button>
            <button class="ctrl-btn" id="btn-filter" onclick="cycleFilter()" title="Color Theme"><i class="fas fa-temperature-high"></i></button>
            <button class="ctrl-btn" id="btn-sort" onclick="toggleSort()" title="Sort"><i class="fas fa-filter"></i></button>
            
            <div style="width:1px; height:24px; background:rgba(255,255,255,0.1);"></div>

            <button class="ctrl-btn" onclick="togglePiP()" title="Picture-in-Picture"><i class="fas fa-external-link-alt"></i></button>
            <button class="ctrl-btn" onclick="toggleSettings()" title="Settings"><i class="fas fa-cog"></i></button>
            <button class="ctrl-btn" onclick="openGrid()" title="Grid View"><i class="fas fa-th"></i></button>
            <button class="ctrl-btn" onclick="addMoreFrames()" title="Add Images"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="grid-view">
        <div id="grid-header">
            <span>Inventory</span>
            <div style="display:flex; gap:15px;">
                <button class="ctrl-btn" onclick="closeGrid()" title="Close (Esc)"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="grid-content"></div>
    </div>

    <div id="toast"></div>

    <script>
        // --- App Settings ---
        const settings = {
            pipSync: true,      
            pipRatioMode: 'fit', // 'fit', 'half-full', 'full', 'dynamic'
            pipShowInfo: false,
            ambientMode: false,
            scaleCover: false
        };

        const pipModes = ['fit', 'half-full', 'full', 'dynamic'];
        let pipModeIndex = 0;

        // --- State ---
        let presets = []; 
        let currentPresetIndex = -1;
        let frames = []; 
        let currentFrameIndex = 0;
        let isPlaying = false;
        let isColorSort = false; 
        
        let albumStats = { modeRatio: 1.77, fullRatio: 1.77 }; // Calculated per album

        let transitionStartTime = 0;
        let transitionDuration = 0;
        let isTransitioning = false;
        
        // --- Zoom & Pan State ---
        let viewScale = 1;
        let viewPanX = 0;
        let viewPanY = 0;
        let isDragging = false;
        let startDragX = 0;
        let startDragY = 0;
        
        // --- PiP State ---
        let isPiPActive = false;
        let pipAnimationFrameId = null;

        const effects = ['none', 'crossfade', 'blur', 'zoom'];
        let currentEffectIndex = 2; 
        const filters = ['none', 'intense', 'cool'];
        let currentFilterIndex = 0;
        
        let playInterval = null;
        let idleTimer = null;
        let dragSrcIndex = null;
        let db;
        const DB_NAME = "PicPicLiveDB";
        const DB_VERSION = 1;
        const STORE_NAME = "images";

        const el = {
            uploadZone: document.getElementById('upload-zone'),
            fileInput: document.getElementById('file-input'),
            folderInput: document.getElementById('folder-input'),
            viewer: document.getElementById('viewer'),
            imgFront: document.getElementById('img-front'),
            imgBack: document.getElementById('img-back'),
            ambientBg: document.getElementById('ambient-bg'),
            uiLayer: document.getElementById('ui-layer'),
            settingsPanel: document.getElementById('settings-panel'),
            filmstrip: document.getElementById('filmstrip'),
            gridView: document.getElementById('grid-view'),
            gridContent: document.getElementById('grid-content'),
            playBtn: document.getElementById('btn-play'),
            effectBtn: document.getElementById('btn-effect'),
            filterBtn: document.getElementById('btn-filter'),
            sortBtn: document.getElementById('btn-sort'),
            speedSlider: document.getElementById('speed-slider'),
            speedVal: document.getElementById('speed-val'),
            masterZoom: document.getElementById('master-zoom'),
            zoomVal: document.getElementById('zoom-val'),
            toast: document.getElementById('toast'),
            canvas: document.getElementById('analysis-canvas'),
            presetBar: document.getElementById('preset-bar'),
            presetList: document.getElementById('preset-list'),
            presetToggle: document.getElementById('btn-presets-toggle'),
            presetSearch: document.getElementById('preset-search'),
            landingGrid: document.getElementById('landing-grid'),
            scanStatus: document.getElementById('scan-status'),
            homeBtn: document.getElementById('btn-home'),
            pipCanvas: document.getElementById('pip-canvas'),
            pipVideo: document.getElementById('pip-video'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalDesc: document.getElementById('modal-desc'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            navZones: document.querySelectorAll('.nav-zone'),
            navCenter: document.getElementById('nav-center'),
            pipRatioBtn: document.getElementById('pip-ratio-btn')
        };

        const ctx = el.canvas.getContext('2d', { willReadFrequently: true });
        const pipCtx = el.pipCanvas.getContext('2d', { alpha: false });
        
        const FILTER_INTENSE = "contrast(1.3) saturate(1.4) brightness(1.1)";
        const FILTER_COOL = "sepia(0.2) contrast(0.9) brightness(0.9) hue-rotate(190deg)";

        // --- 1. MODAL SYSTEM ---
        function showConfirm(title, msg, onYes) {
            el.modalTitle.innerText = title;
            el.modalDesc.innerText = msg;
            const newBtn = el.modalConfirmBtn.cloneNode(true);
            el.modalConfirmBtn.parentNode.replaceChild(newBtn, el.modalConfirmBtn);
            el.modalConfirmBtn = newBtn;
            el.modalConfirmBtn.onclick = () => { onYes(); closeModal(); };
            el.modalOverlay.style.display = "flex";
            setTimeout(() => el.modalOverlay.classList.add('active'), 10);
        }

        function closeModal() {
            el.modalOverlay.classList.remove('active');
            setTimeout(() => el.modalOverlay.style.display = "none", 300);
        }

        // --- 2. SETTINGS LOGIC ---
        function toggleSettings() {
            el.settingsPanel.classList.toggle('active');
            if(el.settingsPanel.classList.contains('active')) {
                el.masterZoom.value = viewScale * 100;
                el.zoomVal.innerText = Math.round(viewScale * 100) + '%';
            }
        }

        function cyclePiPRatio() {
            pipModeIndex = (pipModeIndex + 1) % pipModes.length;
            settings.pipRatioMode = pipModes[pipModeIndex];
            
            // Format Display Name
            let name = "Fit";
            if(settings.pipRatioMode === 'half-full') name = "Half-Full";
            if(settings.pipRatioMode === 'full') name = "Full";
            if(settings.pipRatioMode === 'dynamic') name = "Dynamic";
            
            el.pipRatioBtn.innerText = name;
            showToast(`PiP: ${name}`);
            
            // Re-render immediate if active
            if(isPiPActive) renderCanvasFrame();
        }

        function updatePiPSettings() {
            settings.pipSync = document.getElementById('pip-sync-check').checked;
            settings.pipShowInfo = document.getElementById('pip-info-check').checked;
        }

        function toggleAmbient() {
            settings.ambientMode = document.getElementById('ambient-check').checked;
            el.ambientBg.style.opacity = settings.ambientMode ? 1 : 0;
            updateDisplay(true); 
        }

        function toggleScaleMode() {
            settings.scaleCover = !settings.scaleCover;
            const mode = settings.scaleCover ? 'cover' : 'contain';
            document.getElementById('scale-mode-btn').innerText = settings.scaleCover ? "Fill" : "Fit";
            el.imgFront.style.objectFit = mode;
            el.imgBack.style.objectFit = mode;
            showToast("Scale: " + (settings.scaleCover ? "Fill Screen" : "Fit Screen"));
        }

        function manualZoom(val) {
            viewScale = val / 100;
            if(viewScale === 1) { viewPanX = 0; viewPanY = 0; }
            el.zoomVal.innerText = val + '%';
            applyViewTransform();
        }

        // --- 3. DATABASE & STATS ---
        window.onload = function() { initDB(); setupInteractions(); };

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => console.error("DB Error", e);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    store.createIndex("groupName", "groupName", { unique: false });
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                loadFromDB();
            };
        }

        function loadFromDB() {
            if (!db) return;
            const transaction = db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                const items = request.result;
                if (items.length > 0) {
                    processDBItems(items);
                    el.scanStatus.style.display = 'none'; 
                } else {
                    el.scanStatus.innerText = "No local albums found.";
                }
            };
        }

        function calculateAlbumStats(framesList) {
            if(!framesList || framesList.length === 0) return;
            
            // Calculate ratios for Half-Full (Mode) and Full (Best Cover)
            const ratioBuckets = {};
            let maxRatio = 0; // "Widest"
            let minRatio = 999; // "Tallest"
            
            framesList.forEach(f => {
                const img = new Image();
                img.src = f.src;
                // We assume immediate load because blobs are local, but to be safe we use 
                // what we know or wait. However, blobs load async. 
                // For simplified logic in single file, we will default stats.
                // In a perfect world we would have saved width/height to DB.
            });

            // Mockup logic since we don't have width/height stored in DB:
            // We will calculate stats dynamically as images load or default to 16:9
            albumStats = { modeRatio: 1.77, fullRatio: 1.77 };
        }
        
        // Asynchronous helper to actually get stats when album loads
        async function analyzeAlbumRatios() {
            const ratios = [];
            for (let i = 0; i < Math.min(frames.length, 50); i++) { // Sample first 50
                await new Promise(r => {
                    const img = new Image();
                    img.onload = () => {
                        ratios.push(img.width / img.height);
                        r();
                    };
                    img.src = frames[i].src;
                });
            }
            
            if(ratios.length === 0) return;

            // 1. Half-Full (Mode)
            const counts = {};
            ratios.forEach(r => {
                const key = r.toFixed(1); // bucket 1.7, 1.3, etc
                counts[key] = (counts[key] || 0) + 1;
            });
            const modeKey = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            albumStats.modeRatio = parseFloat(modeKey);

            // 2. Full (Best Coverage) -> Prompt says: "16:9 will be a zoom in 16:10". 
            // 16:10 (1.6) is taller than 16:9 (1.77). 
            // So we want the "Tallest" common ratio to act as container (Cover mode).
            // We pick the smallest ratio value (closest to 1 or square) from the top 3 common ones.
            const sortedKeys = Object.keys(counts).sort((a,b) => counts[b] - counts[a]); // Most common first
            const top3 = sortedKeys.slice(0, 3).map(k => parseFloat(k));
            albumStats.fullRatio = Math.min(...top3); // The "tallest" of the common ratios
        }

        function askClearDB() {
            showConfirm("Reset All Data?", "Delete all imported images?", () => {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const req = store.clear();
                req.onsuccess = () => {
                    showToast("Database Cleared");
                    setTimeout(() => location.reload(), 500);
                };
            });
        }

        function saveToDB(item) {
            if (!db) return;
            const transaction = db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            store.put(item);
        }

        function processDBItems(items) {
            const grouped = {};
            items.forEach(item => {
                item.src = URL.createObjectURL(item.blob);
                if (!grouped[item.groupName]) grouped[item.groupName] = [];
                grouped[item.groupName].push(item);
            });
            Object.keys(grouped).forEach(gName => {
                createPreset(gName, grouped[gName]);
            });
        }

        function deleteAlbum(name) {
            showConfirm("Delete Album?", `Delete "${name}"?`, () => {
                presets = presets.filter(p => p.name !== name);
                renderPresetList(el.presetSearch.value);
                renderLandingGrid();
                if(!db) return;
                const tx = db.transaction([STORE_NAME], "readwrite");
                const store = tx.objectStore(STORE_NAME);
                const index = store.index("groupName");
                const req = index.getAllKeys(IDBKeyRange.only(name));
                req.onsuccess = () => {
                    req.result.forEach(key => store.delete(key));
                    showToast(`Album "${name}" Deleted`);
                };
            });
        }

        // --- 4. INTERACTIONS ---
        function setupInteractions() {
            el.viewer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.1;
                const delta = e.deltaY > 0 ? -zoomIntensity : zoomIntensity;
                viewScale = Math.min(Math.max(1, viewScale + delta), 5);
                if (viewScale === 1) { viewPanX = 0; viewPanY = 0; }
                el.masterZoom.value = viewScale * 100;
                el.zoomVal.innerText = Math.round(viewScale * 100) + '%';
                applyViewTransform();
                resetIdle();
            }, { passive: false });

            el.navCenter.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', endDrag);

            el.navCenter.addEventListener('dblclick', () => {
                viewScale = 1; viewPanX = 0; viewPanY = 0;
                applyViewTransform();
            });
        }

        function startDrag(e) {
            isDragging = true;
            startDragX = e.clientX - viewPanX;
            startDragY = e.clientY - viewPanY;
            el.viewer.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            viewPanX = e.clientX - startDragX;
            viewPanY = e.clientY - startDragY;
            applyViewTransform();
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            el.viewer.style.cursor = 'grab';
            const movedX = Math.abs((e.clientX - startDragX) - viewPanX);
            const movedY = Math.abs((e.clientY - startDragY) - viewPanY);
            if (movedX < 5 && movedY < 5) toggleUI();
        }

        function applyViewTransform() {
            const transform = `translate(${viewPanX}px, ${viewPanY}px) scale(${viewScale})`;
            el.imgFront.style.transform = transform;
            el.imgBack.style.transform = transform;
            if(isPiPActive) renderCanvasFrame();
        }

        // --- 5. NAVIGATION ---
        document.addEventListener('keydown', (e) => {
            if(el.presetSearch === document.activeElement) return;
            switch(e.key) {
                case "ArrowRight": nextSlide(); break;
                case "ArrowLeft": prevSlide(); break;
                case " ": e.preventDefault(); togglePlay(); resetIdle(); break;
                case "Escape":
                    if(document.pictureInPictureElement) document.exitPictureInPicture();
                    else if(el.gridView.style.display === 'flex') closeGrid();
                    else if(el.presetBar.classList.contains('open')) toggleSidebar();
                    else if(el.settingsPanel.classList.contains('active')) toggleSettings();
                    else if(el.viewer.style.display !== 'none') goHome();
                    break;
                case "f": toggleFullScreen(); break;
            }
        });

        function resetIdle() {
            if (frames.length === 0 || el.gridView.style.display === 'flex' || el.uploadZone.style.display !== 'none') return;
            el.uiLayer.classList.remove('hidden');
            el.homeBtn.style.display = 'flex';
            el.navZones.forEach(z => z.style.display = 'block');

            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                if(!el.presetBar.classList.contains('open') && !el.settingsPanel.classList.contains('active') && !isDragging) {
                    el.uiLayer.classList.add('hidden');
                    el.homeBtn.style.display = 'none';
                    el.navZones.forEach(z => z.style.display = 'none');
                }
            }, 3500);
        }

        window.addEventListener('mousemove', resetIdle);
        window.addEventListener('click', (e) => {
            if(el.presetBar.contains(e.target) || el.presetToggle.contains(e.target) || el.settingsPanel.contains(e.target)) return;
        });

        function toggleUI() {
            if (el.uiLayer.classList.contains('hidden')) resetIdle();
            else {
                el.uiLayer.classList.add('hidden');
                el.homeBtn.style.display = 'none';
                clearTimeout(idleTimer);
            }
        }

        function nextSlide() {
            if(frames.length === 0) return;
            currentFrameIndex = (currentFrameIndex + 1) % frames.length;
            updateDisplay(true); 
            updateFilmstripHighlight();
            resetIdle();
        }

        function prevSlide() {
            if(frames.length === 0) return;
            currentFrameIndex = (currentFrameIndex - 1 + frames.length) % frames.length;
            updateDisplay(true);
            updateFilmstripHighlight();
            resetIdle();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function toggleSidebar() {
            el.presetBar.classList.toggle('open');
            if(el.presetBar.classList.contains('open')) {
                el.uiLayer.classList.add('hidden');
                el.presetToggle.style.opacity = '0';
                el.presetToggle.style.pointerEvents = 'none';
            } else {
                el.presetToggle.style.opacity = '1';
                el.presetToggle.style.pointerEvents = 'auto';
            }
        }

        function goHome() {
            isPlaying = false;
            clearInterval(playInterval);
            el.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (document.pictureInPictureElement) document.exitPictureInPicture();
            
            el.viewer.style.display = 'none';
            el.uiLayer.classList.add('hidden');
            el.homeBtn.style.display = 'none';
            el.gridView.style.display = 'none';
            el.settingsPanel.classList.remove('active');
            el.navZones.forEach(z => z.style.display = 'none');
            
            el.uploadZone.classList.remove('hidden');
            el.uploadZone.style.display = 'flex';
            el.ambientBg.style.opacity = 0;
            
            renderLandingGrid();
            viewScale = 1; viewPanX = 0; viewPanY = 0;
            applyViewTransform();
        }

        // --- 6. PIP RENDERER (Enhanced Ratios) ---
        async function togglePiP() {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else {
                try {
                    await startPiP();
                } catch (error) {
                    console.error(error);
                    showToast("PiP Failed: " + error.message);
                }
            }
        }

        async function startPiP() {
            if (frames.length === 0) return;
            renderCanvasFrame();
            
            if (el.pipVideo.srcObject === null) {
                const stream = el.pipCanvas.captureStream(60); 
                el.pipVideo.srcObject = stream;
            }

            await el.pipVideo.play();
            await el.pipVideo.requestPictureInPicture();
            isPiPActive = true;
            renderLoop();
            showToast("PiP Active");
            
            el.pipVideo.addEventListener('leavepictureinpicture', () => {
                isPiPActive = false;
                cancelAnimationFrame(pipAnimationFrameId);
            }, { once: true });
        }

        function renderLoop() {
            if (!isPiPActive) return;
            renderCanvasFrame();
            pipAnimationFrameId = requestAnimationFrame(renderLoop);
        }

        function easeInOutQuad(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }

        function renderCanvasFrame() {
            if (frames.length === 0) return;

            const frontFrame = frames[currentFrameIndex];
            const imgEl = el.imgFront; 
            
            // --- PIP RESIZE LOGIC ---
            let targetW, targetH;
            const BASE_H = 720; // Fixed resolution base

            if(settings.pipRatioMode === 'fit') {
                // Default: Match Image
                targetW = imgEl.naturalWidth || 1280;
                targetH = imgEl.naturalHeight || 720;
            } else if(settings.pipRatioMode === 'half-full') {
                // Mode Ratio (Contain)
                targetH = BASE_H;
                targetW = BASE_H * albumStats.modeRatio;
            } else if(settings.pipRatioMode === 'full') {
                // Best Ratio (Cover)
                targetH = BASE_H;
                targetW = BASE_H * albumStats.fullRatio;
            } else if(settings.pipRatioMode === 'dynamic') {
                // 16:9 Fixed Container
                targetH = BASE_H;
                targetW = BASE_H * 1.777; // 1280x720
            }

            // Update Canvas Size
            if(el.pipCanvas.width !== targetW || el.pipCanvas.height !== targetH) {
                el.pipCanvas.width = targetW;
                el.pipCanvas.height = targetH;
            }
            
            const w = el.pipCanvas.width;
            const h = el.pipCanvas.height;
            
            pipCtx.fillStyle = '#000';
            pipCtx.fillRect(0, 0, w, h);

            pipCtx.save();
            
            // --- DRAW LOGIC (Contain vs Cover) ---
            // If Dynamic or Half-Full, we Contain. If Full, we Cover.
            let drawMode = 'contain';
            if(settings.pipRatioMode === 'full') drawMode = 'cover';

            // Calculate Scale for Contain/Cover manually for Canvas
            // Aspect Ratio of Canvas vs Image
            const canvasRatio = w / h;
            const imgRatio = (imgEl.naturalWidth / imgEl.naturalHeight) || 1.77;
            
            let scaleFactor = 1;
            if (drawMode === 'cover') {
                // Scale to fill
                if (imgRatio > canvasRatio) scaleFactor = h / imgEl.naturalHeight; 
                else scaleFactor = w / imgEl.naturalWidth;
            } else {
                // Scale to fit (contain)
                if (imgRatio > canvasRatio) scaleFactor = w / imgEl.naturalWidth;
                else scaleFactor = h / imgEl.naturalHeight;
            }
            
            // Center the context
            pipCtx.translate(w/2, h/2);
            
            // Apply Master Zoom/Pan (if Sync)
            if(settings.pipSync) {
                pipCtx.translate(viewPanX, viewPanY);
                pipCtx.scale(viewScale, viewScale);
            }
            
            // Apply Contain/Cover Scale
            // We need to scale the image to fit the canvas, centered.
            // But 'drawImage' draws at original size. So we scale context.
            // Wait, we need to undo the w/2, h/2 translation to draw.
            // Better: Scale context by scaleFactor.
            pipCtx.scale(scaleFactor, scaleFactor);
            
            // Apply Image Center Offset
            pipCtx.translate(-imgEl.naturalWidth/2, -imgEl.naturalHeight/2);

            // Transition Logic
            const now = Date.now();
            let linearProgress = 0;
            if (isTransitioning && transitionDuration > 0) {
                linearProgress = (now - transitionStartTime) / transitionDuration;
                if (linearProgress >= 1) { isTransitioning = false; linearProgress = 1; }
            } else { linearProgress = 1; }
            
            const progress = easeInOutQuad(linearProgress);
            const effect = effects[currentEffectIndex];
            const filter = getFilterString(frontFrame);

            const drawImg = (domId, alpha, extraScale = 1, blurPx = 0) => {
                const img = document.getElementById(domId);
                if (!img || !img.complete || img.naturalWidth === 0) return;
                
                pipCtx.globalAlpha = alpha;
                let appliedFilter = filter !== 'none' ? filter : '';
                if (blurPx > 0) appliedFilter += ` blur(${blurPx}px)`;
                pipCtx.filter = appliedFilter || 'none';

                if (extraScale !== 1) {
                    // Zoom effect relative to image center
                    pipCtx.save();
                    pipCtx.translate(img.naturalWidth/2, img.naturalHeight/2);
                    pipCtx.scale(extraScale, extraScale);
                    pipCtx.translate(-img.naturalWidth/2, -img.naturalHeight/2);
                    pipCtx.drawImage(img, 0, 0);
                    pipCtx.restore();
                } else {
                    pipCtx.drawImage(img, 0, 0);
                }
            };

            if (linearProgress < 1) {
                drawImg('img-back', 1.0); 
                if (effect === 'crossfade') drawImg('img-front', progress);
                else if (effect === 'zoom') {
                    const transScale = 1.1 - (0.1 * progress);
                    drawImg('img-front', progress, transScale);
                } 
                else if (effect === 'blur') {
                    const blur = 15 * (1 - progress);
                    drawImg('img-front', progress, 1, blur);
                } 
                else drawImg('img-front', 1);
            } else {
                drawImg('img-front', 1.0);
            }

            // Info Overlay
            if(settings.pipShowInfo) {
                pipCtx.restore(); // Reset all transforms to draw text in screen space
                pipCtx.save();
                pipCtx.globalAlpha = 1.0;
                pipCtx.filter = 'none';
                pipCtx.fillStyle = "rgba(0,0,0,0.6)";
                pipCtx.fillRect(20, h - 60, 400, 40);
                pipCtx.fillStyle = "#fff";
                pipCtx.font = "bold 20px Arial";
                pipCtx.fillText(frontFrame.name, 40, h - 32);
            }

            pipCtx.restore();
        }

        // --- 7. FILE IMPORT ---
        document.addEventListener('paste', e => handleFiles(e.clipboardData.files));
        el.fileInput.addEventListener('change', e => handleFiles(e.target.files));
        el.folderInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if(files.length > 0) handleFiles(files, null, true);
        });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => { 
            e.preventDefault(); 
            const items = e.dataTransfer.items;
            if (items && items[0] && items[0].webkitGetAsEntry && items[0].webkitGetAsEntry().isDirectory) {
                handleFiles(e.dataTransfer.files, null, true);
            } else {
                handleFiles(e.dataTransfer.files); 
            }
        });
        
        function addMoreFrames() { el.fileInput.click(); }
        function downloadCurrent() {
            if(frames.length === 0) return;
            const a = document.createElement('a');
            a.href = frames[currentFrameIndex].src;
            a.download = frames[currentFrameIndex].name;
            a.click();
            showToast("Saved Image");
        }

        function handleFiles(fileList, presetName = null, isFolderImport = false) {
            if(!fileList || fileList.length === 0) return;
            const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
            if(files.length === 0) return;

            showToast(`Processing ${files.length} images...`);

            let index = 0;
            const chunkSize = 10;
            const folderGroups = {}; 
            const singleFrames = [];

            function processChunk() {
                const chunk = files.slice(index, index + chunkSize);
                let processedInChunk = 0;
                chunk.forEach(file => {
                    let groupName = "Imported";
                    if (isFolderImport && file.webkitRelativePath) {
                        const parts = file.webkitRelativePath.split('/');
                        if (parts.length >= 2) groupName = parts[parts.length - 2];
                    } else if (presetName) {
                        groupName = presetName;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const hue = extractHue(img);
                            let temp = 'neutral';
                            if (hue < 60 || hue > 300) temp = 'warm';
                            else if (hue > 150 && hue < 270) temp = 'cool';

                            const frameData = {
                                id: Date.now() + Math.random(),
                                blob: file, 
                                name: file.name,
                                hue: hue,
                                temp: temp,
                                groupName: groupName,
                                src: e.target.result
                            };
                            saveToDB(frameData);
                            if (isFolderImport) {
                                if (!folderGroups[groupName]) folderGroups[groupName] = [];
                                folderGroups[groupName].push(frameData);
                            } else {
                                singleFrames.push(frameData);
                            }
                            processedInChunk++;
                            if (processedInChunk === chunk.length) {
                                index += chunkSize;
                                if (index < files.length) {
                                    setTimeout(processChunk, 10);
                                } else {
                                    finishImport(folderGroups, singleFrames, presetName, isFolderImport);
                                }
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
            processChunk();
        }

        function finishImport(folderGroups, singleFrames, presetName, isFolderImport) {
            if (isFolderImport) {
                Object.keys(folderGroups).forEach(gName => {
                    createPreset(gName, folderGroups[gName]);
                });
                showToast(`Imported ${Object.keys(folderGroups).length} Albums`);
            } else {
                if (presetName) {
                    createPreset(presetName, singleFrames);
                } else {
                    frames = frames.concat(singleFrames);
                    applyCurrentSort(); 
                    onFramesUpdated();
                }
            }
            renderLandingGrid();
        }

        // --- 8. LOGIC & VISUALS ---
        function createPreset(name, framesArray) {
            let existing = presets.find(p => p.name === name);
            if (existing) {
                const currentIds = new Set(existing.frames.map(f => f.id));
                framesArray.forEach(f => {
                    if(!currentIds.has(f.id)) existing.frames.push(f);
                });
                existing.frames.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            } else {
                framesArray.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                presets.push({ name: name, frames: framesArray });
            }
            renderPresetList();
            renderLandingGrid();
        }

        function generateCardHTML(preset) {
            const count = preset.frames.length;
            let gridHTML = '';
            let layoutClass = 'layout-4';

            if (count === 1) {
                layoutClass = 'layout-1';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb" style="object-position: center top;">`;
            } else if (count === 2) {
                layoutClass = 'layout-2';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb"><img src="${preset.frames[1].src}" class="album-thumb">`;
            } else if (count === 3) {
                layoutClass = 'layout-3';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb"><img src="${preset.frames[1].src}" class="album-thumb"><img src="${preset.frames[2].src}" class="album-thumb">`;
            } else {
                for(let i=0; i<4; i++) {
                    if (preset.frames[i]) {
                        if (i === 3 && count > 4) {
                            gridHTML += `<div class="album-more-wrap"><img src="${preset.frames[i].src}"><div class="album-remaining">+${count - 4}</div></div>`;
                        } else {
                            gridHTML += `<img src="${preset.frames[i].src}" class="album-thumb">`;
                        }
                    }
                }
            }
            const delBtn = `<button class="album-delete-btn" onclick="event.stopPropagation(); deleteAlbum('${preset.name}')" title="Delete"><i class="fas fa-trash-alt"></i></button>`;
            return `${delBtn}<div class="album-grid ${layoutClass}">${gridHTML}</div><div class="album-info"><div class="album-name">${preset.name}</div><div class="album-meta"><span>${count} items</span></div></div>`;
        }

        function renderPresetList(filter = "") {
            el.presetList.innerHTML = '';
            presets.forEach((preset, index) => {
                if (filter && !preset.name.toLowerCase().includes(filter.toLowerCase())) return;
                const card = document.createElement('div');
                card.className = 'album-card' + (index === currentPresetIndex ? ' active' : '');
                card.innerHTML = generateCardHTML(preset);
                card.onclick = () => loadPreset(index);
                el.presetList.appendChild(card);
            });
        }

        function renderLandingGrid() {
            if(!el.landingGrid) return;
            el.landingGrid.innerHTML = '';
            presets.forEach((preset, index) => {
                const card = document.createElement('div');
                card.className = 'landing-card';
                card.innerHTML = generateCardHTML(preset);
                card.onclick = () => loadPreset(index);
                el.landingGrid.appendChild(card);
            });
        }
        function filterPresets() { renderPresetList(el.presetSearch.value); }

        function loadPreset(index) {
            currentPresetIndex = index;
            frames = [...presets[index].frames]; 
            applyCurrentSort();
            analyzeAlbumRatios(); // Calculate Stats for PiP
            onFramesUpdated();
            renderPresetList(el.presetSearch.value); 
            el.presetBar.classList.remove('open');
            el.presetToggle.style.opacity = '1';
            el.presetToggle.style.pointerEvents = 'auto';
        }

        function extractHue(img) {
            try {
                el.canvas.width = 30; el.canvas.height = 30;
                ctx.drawImage(img, 0, 0, 30, 30);
                const data = ctx.getImageData(0, 0, 30, 30).data;
                let r=0, g=0, b=0, count=0;
                for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++; }
                r/=255; g/=255; b/=255;
                const max=Math.max(r,g,b), min=Math.min(r,g,b);
                let h=0;
                if(max!==min) {
                    const d=max-min;
                    switch(max) {
                        case r: h=(g-b)/d+(g<b?6:0); break;
                        case g: h=(b-r)/d+2; break;
                        case b: h=(r-g)/d+4; break;
                    }
                    h/=6;
                }
                return h*360;
            } catch(e) { return 0; }
        }

        function onFramesUpdated() {
            el.uploadZone.style.display = 'none';
            el.viewer.style.display = 'flex';
            el.homeBtn.style.display = 'flex';
            el.navZones.forEach(z => z.style.display = 'block');
            
            renderFilmstrip();
            if(el.gridView.style.display === 'flex') renderGrid(); 

            if (!isPlaying && frames.length > 0) {
                isPlaying = true;
                currentFrameIndex = 0;
                startLoop();
                // FIX: Update icon immediately
                el.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
            updateDisplay(true);
        }

        function toggleSort() {
            isColorSort = !isColorSort;
            el.sortBtn.classList.toggle('active-sort', isColorSort);
            el.sortBtn.innerHTML = isColorSort ? '<i class="fas fa-palette"></i>' : '<i class="fas fa-font"></i>';
            applyCurrentSort();
            showToast(isColorSort ? "Sorted by Color" : "Sorted by Name");
        }

        function applyCurrentSort() {
            if (isColorSort) {
                frames.sort((a, b) => {
                    const hueGroupA = Math.floor(a.hue / 30);
                    const hueGroupB = Math.floor(b.hue / 30);
                    if (hueGroupA !== hueGroupB) return hueGroupA - hueGroupB;
                    return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
                });
            } else {
                frames.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            }
            currentFrameIndex = 0; 
            updateDisplay(true);
            renderFilmstrip();
            if(el.gridView.style.display === 'flex') renderGrid();
        }

        function openGrid() {
            isPlaying = false; 
            clearInterval(playInterval);
            el.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            el.gridView.style.display = 'flex';
            renderGrid();
        }
        function closeGrid() {
            el.gridView.style.display = 'none';
            renderFilmstrip(); 
            updateDisplay(true);
        }
        function renderGrid() {
            el.gridContent.innerHTML = '';
            frames.forEach((frame, index) => {
                const item = document.createElement('div');
                item.className = 'grid-item' + (index === currentFrameIndex ? ' active' : '');
                item.draggable = true;
                const img = document.createElement('img');
                img.src = frame.src;
                if (getFilterString(frame) !== "none") img.style.filter = getFilterString(frame);
                const del = document.createElement('button');
                del.className = 'grid-delete';
                del.innerHTML = '<i class="fas fa-trash"></i>';
                del.onclick = (e) => { e.stopPropagation(); removeFrame(index); };
                item.onclick = () => { currentFrameIndex = index; closeGrid(); };
                
                item.addEventListener('dragstart', (e) => { dragSrcIndex = index; e.dataTransfer.effectAllowed = 'move'; });
                item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                item.addEventListener('drop', (e) => {
                    e.stopPropagation();
                    if(dragSrcIndex !== index) {
                        const itm = frames[dragSrcIndex];
                        frames.splice(dragSrcIndex, 1);
                        frames.splice(index, 0, itm);
                        if(currentFrameIndex === dragSrcIndex) currentFrameIndex = index;
                        renderGrid();
                    }
                });
                item.appendChild(img);
                item.appendChild(del);
                el.gridContent.appendChild(item);
            });
        }

        function startLoop() {
            if(playInterval) clearInterval(playInterval);
            if(!isPlaying || frames.length === 0) return;
            const delay = parseInt(el.speedSlider.value);
            playInterval = setInterval(() => {
                currentFrameIndex = (currentFrameIndex + 1) % frames.length;
                updateDisplay();
                updateFilmstripHighlight();
            }, delay);
        }

        function getFilterString(frame) {
            const mode = filters[currentFilterIndex];
            if (mode === 'intense') return FILTER_INTENSE;
            if (mode === 'cool') return FILTER_COOL;
            return "none";
        }

        function updateDisplay(instant = false) {
            if (frames.length === 0) return;
            const frame = frames[currentFrameIndex];
            
            // Set Start Time for PiP Sync
            transitionStartTime = Date.now();
            const speedVal = parseInt(el.speedSlider.value);
            transitionDuration = instant ? 0 : Math.min(speedVal * 0.9, 1500); 
            isTransitioning = !instant;
            
            const effect = effects[currentEffectIndex];
            const baseFilter = getFilterString(frame);
            
            // Ambient BG Update
            if(settings.ambientMode) el.ambientBg.style.backgroundImage = `url(${frame.src})`;

            el.imgBack.src = el.imgFront.src;
            el.imgBack.style.cssText = el.imgFront.style.cssText;
            el.imgBack.style.transition = 'none';
            el.imgBack.style.opacity = 1;
            el.imgBack.style.objectFit = settings.scaleCover ? 'cover' : 'contain';

            el.imgFront.src = frame.src;
            el.imgFront.style.transition = 'none';
            el.imgFront.style.opacity = 0;
            el.imgFront.style.objectFit = settings.scaleCover ? 'cover' : 'contain';
            
            applyViewTransform();
            
            if (isTransitioning && effect !== 'none') {
                if(effect === 'blur') {
                    const blurStr = "blur(15px)";
                    el.imgFront.style.filter = baseFilter !== 'none' ? `${baseFilter} ${blurStr}` : blurStr;
                } else {
                    el.imgFront.style.filter = baseFilter;
                }
                void el.imgFront.offsetWidth; 
                el.imgFront.style.transition = `opacity ${transitionDuration}ms ease-in-out, filter ${transitionDuration}ms ease-in-out`;
                el.imgFront.style.opacity = 1;
                
                if(effect === 'blur') el.imgFront.style.filter = baseFilter !== 'none' ? `${baseFilter} blur(0px)` : 'blur(0px)';

            } else {
                el.imgFront.style.transition = 'none';
                el.imgFront.style.opacity = 1;
                el.imgFront.style.filter = baseFilter;
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            el.playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            if(isPlaying) startLoop(); else clearInterval(playInterval);
            if(!isPlaying) showToast("Paused");
        }

        function cycleEffect() {
            currentEffectIndex = (currentEffectIndex + 1) % effects.length;
            const names = ['Hard Cut', 'Crossfade', 'Blur', 'Zoom'];
            showToast(`Transition: ${names[currentEffectIndex]}`);
            el.effectBtn.style.color = currentEffectIndex === 0 ? '#aaa' : '#3b82f6';
        }

        function cycleFilter() {
            currentFilterIndex = (currentFilterIndex + 1) % filters.length;
            const mode = filters[currentFilterIndex];
            el.filterBtn.className = 'ctrl-btn';
            let color = '#aaa';
            if(mode === 'intense') color = '#f43f5e'; 
            if(mode === 'cool') color = '#3b82f6';
            el.filterBtn.style.color = color;
            showToast(`Filter: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
            updateDisplay(true); 
            if(el.gridView.style.display === 'flex') renderGrid(); 
        }

        el.speedSlider.addEventListener('input', () => { 
            const val = (el.speedSlider.value / 1000).toFixed(1);
            el.speedVal.textContent = val + 's';
            if(isPlaying) startLoop(); 
        });

        function renderFilmstrip() {
            el.filmstrip.innerHTML = '';
            frames.forEach((frame, index) => {
                const wrap = document.createElement('div');
                wrap.className = 'thumb-wrap' + (index === currentFrameIndex ? ' active' : '');
                wrap.draggable = true;
                const img = document.createElement('img');
                img.src = frame.src;
                wrap.onclick = () => { currentFrameIndex = index; updateDisplay(true); updateFilmstripHighlight(); };
                wrap.addEventListener('dragstart', e => { dragSrcIndex = index; e.dataTransfer.effectAllowed = 'move'; });
                wrap.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                wrap.addEventListener('drop', e => {
                    e.stopPropagation();
                    if (dragSrcIndex !== index) {
                        const item = frames[dragSrcIndex];
                        frames.splice(dragSrcIndex, 1);
                        frames.splice(index, 0, item);
                        if(currentFrameIndex === dragSrcIndex) currentFrameIndex = index;
                        renderFilmstrip(); updateDisplay(true);
                    }
                });
                wrap.appendChild(img);
                el.filmstrip.appendChild(wrap);
            });
        }

        function updateFilmstripHighlight() {
            const thumbs = document.querySelectorAll('.thumb-wrap');
            thumbs.forEach((t, i) => {
                if(i === currentFrameIndex) {
                    t.classList.add('active');
                    t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else t.classList.remove('active');
            });
        }

        function removeFrame(index) {
            const frame = frames[index];
            if(!frame) return;
            showConfirm("Delete Image?", "Remove from view?", () => {
                if(db) {
                    const tx = db.transaction([STORE_NAME], "readwrite");
                    tx.objectStore(STORE_NAME).delete(frame.id);
                }
                frames.splice(index, 1);
                presets.forEach(p => { p.frames = p.frames.filter(f => f.id !== frame.id); });
                renderPresetList(el.presetSearch.value); 
                if(frames.length === 0) goHome();
                else {
                    if(currentFrameIndex >= frames.length) currentFrameIndex = 0;
                    renderFilmstrip(); 
                    if(el.gridView.style.display === 'flex') renderGrid();
                    updateDisplay(true);
                }
            });
        }

        function showToast(msg) {
            el.toast.textContent = msg;
            el.toast.style.opacity = '1';
            setTimeout(() => el.toast.style.opacity = '0', 2000);
        }
    </script>
</body>
</html>