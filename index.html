<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immersive Sequence Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: rgba(18, 18, 18, 0.95);
            --accent: #3b82f6;
            --danger: #ef4444;
            --text: #ffffff;
            --grid-bg: rgba(5, 5, 5, 0.98);
            --sidebar-width: 300px;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); overflow: hidden;
            font-family: 'Segoe UI', sans-serif; color: var(--text);
            user-select: none;
        }

        /* --- Custom Modal (Replaces Browser Popup) --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        #modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: #151515; border: 1px solid #333; width: 350px;
            border-radius: 16px; padding: 25px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #modal-overlay.active .modal-box { transform: scale(1); }

        .modal-icon { font-size: 3rem; color: var(--danger); margin-bottom: 15px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: #fff; }
        .modal-desc { font-size: 0.9rem; color: #aaa; margin-bottom: 25px; line-height: 1.5; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn {
            border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-cancel { background: #222; color: #ccc; border: 1px solid #333; }
        .btn-cancel:hover { background: #333; color: #fff; }
        .btn-confirm { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-confirm:hover { background: #dc2626; transform: translateY(-2px); }

        /* --- Upload Zone --- */
        #upload-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
            z-index: 100; background-color: #050505; border: 2px dashed #333;
            transition: opacity 0.3s;
            overflow-y: auto; padding-top: 5vh; box-sizing: border-box;
        }
        #upload-zone.hidden { display: none; }
        
        .upload-content { text-align: center; margin-bottom: 30px; }
        .upload-content i.main-icon { font-size: 5rem; margin-bottom: 20px; color: #444; }
        .upload-options { display: flex; gap: 20px; margin-top: 20px; justify-content: center; flex-wrap: wrap;}
        .up-btn {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
            font-size: 0.9rem;
        }
        .up-btn:hover { background: #333; border-color: #666; }

        /* --- Landing Grid (Lower Part) --- */
        #landing-grid-container {
            width: 90%; max-width: 1200px;
            animation: fadeIn 0.8s ease-out;
            padding-bottom: 50px;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        #landing-header {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            color: #666; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 25px; border-bottom: 1px solid #222; padding-bottom: 10px;
        }
        #landing-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;
        }
        .landing-card {
            width: 240px; background: #151515; border: 1px solid #333; border-radius: 12px;
            overflow: hidden; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; position: relative;
        }
        .landing-card:hover { transform: translateY(-8px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* --- Viewer --- */
        #viewer {
            position: relative; width: 100%; height: 100vh;
            display: none; justify-content: center; align-items: center;
            overflow: hidden; 
        }
        .frame-display {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(1);
            max-width: 100%; max-height: 100%;
            object-fit: contain;
            transition: filter 0.5s ease;
        }
        /* Smart Filters */
        .theme-warm { filter: sepia(0.4) saturate(1.5) hue-rotate(-30deg) contrast(1.1); }
        .theme-cool { filter: sepia(0.3) saturate(1.2) hue-rotate(170deg) brightness(1.1); }
        
        #img-back { z-index: 1; }
        #img-front { z-index: 2; }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            padding-bottom: 30px; z-index: 200;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s;
        }
        #ui-layer.hidden { transform: translateY(150px); opacity: 0; pointer-events: none; }

        /* --- Visual Preset Sidebar --- */
        #preset-bar {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--sidebar-width);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px);
            z-index: 300; transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-right: 1px solid #333; display: flex; flex-direction: column;
            padding: 20px; box-sizing: border-box;
        }
        #preset-bar.open { transform: translateX(0); }
        
        .sidebar-header { margin-bottom: 15px; }
        .sidebar-header h3 { margin: 0 0 10px 0; font-weight: 300; letter-spacing: 1px; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center;}
        
        #preset-search {
            width: 100%; padding: 10px; background: #222; border: 1px solid #444;
            color: #fff; border-radius: 6px; box-sizing: border-box; outline: none;
            font-size: 0.9rem; margin-bottom: 10px;
        }
        #preset-search:focus { border-color: var(--accent); }

        .path-indicator {
            font-family: monospace; font-size: 0.7rem; color: #666; margin-bottom: 15px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        #preset-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-right: 5px; }
        
        /* Album Card Styling Sidebar */
        .album-card {
            background: #1a1a1a; border-radius: 8px; overflow: hidden;
            border: 1px solid #333; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; position: relative;
        }
        .album-card:hover { transform: translateY(-2px); border-color: #555; }
        .album-card.active { border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        
        /* --- Album Delete Button (Improved) --- */
        .album-delete-btn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0, 0.7); color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 6px; 
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: 0.2s; z-index: 50; /* High Z-Index */
            backdrop-filter: blur(4px);
        }
        .album-card:hover .album-delete-btn, .landing-card:hover .album-delete-btn { opacity: 1; }
        .album-delete-btn:hover { background: #ef4444; color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

        /* Grid Area */
        .album-grid {
            display: grid; gap: 1px; aspect-ratio: 16/9; background: #000;
        }
        .album-grid.layout-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .album-grid.layout-1 { grid-template-columns: 1fr; grid-template-rows: 1fr; }
        .album-grid.layout-2 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        .album-grid.layout-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .album-grid.layout-3 img:first-child { grid-column: span 2; }
        
        .album-thumb { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .album-more-wrap { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .album-more-wrap img { width: 100%; height: 100%; object-fit: cover; filter: blur(4px); transform: scale(1.1); }
        .album-remaining {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.4); color: #fff; font-weight: bold; font-size: 1.1rem;
            backdrop-filter: blur(2px); text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* Footer Info */
        .album-info {
            padding: 10px 12px; background: #222; border-top: 1px solid #333;
            display: flex; flex-direction: column; gap: 4px;
        }
        .album-name {
            font-size: 0.9rem; font-weight: 600; color: #eee;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .album-meta { display: flex; justify-content: flex-end; width: 100%; }
        .album-total-count { font-size: 0.7rem; color: #666; font-weight: 500; letter-spacing: 0.5px; }

        /* --- Buttons --- */
        #btn-presets-toggle {
            position: fixed; top: 20px; left: 20px; z-index: 301;
            background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1);
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        #btn-presets-toggle:hover { color: #fff; background: rgba(255,255,255,0.1); }

        #btn-home {
            position: fixed; top: 20px; right: 20px; z-index: 301;
            background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1);
            width: 40px; height: 40px; border-radius: 8px; cursor: pointer;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        #btn-home:hover { color: #fff; background: rgba(220, 38, 38, 0.4); border-color: rgba(220, 38, 38, 0.6); }

        /* --- Filmstrip --- */
        #filmstrip {
            display: flex; gap: 8px; padding: 10px 15px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            border-radius: 12px; margin-bottom: 15px;
            overflow-x: auto; max-width: 85vw; scrollbar-width: thin;
        }
        .thumb-wrap {
            position: relative; width: 50px; height: 50px; flex-shrink: 0;
            border-radius: 6px; overflow: hidden;
            cursor: grab; transition: 0.2s; background: #111; opacity: 0.6;
            border: 2px solid transparent;
        }
        .thumb-wrap.active { border-color: var(--accent); opacity: 1; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .thumb-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- Grid Inventory --- */
        #grid-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--grid-bg); z-index: 400;
            display: none; flex-direction: column; padding: 20px 40px; box-sizing: border-box;
            backdrop-filter: blur(20px);
        }
        #grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        #grid-header span { font-size: 1.8rem; font-weight: 300; letter-spacing: 1px; color: #eee; }
        #grid-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; overflow-y: auto; flex: 1; padding-bottom: 50px; }
        .grid-item { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; background: #1a1a1a; cursor: pointer; transition: transform 0.2s ease; }
        .grid-item:hover { transform: translateY(-4px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 5; }
        .grid-item.active { outline: 2px solid var(--accent); outline-offset: -2px; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .grid-delete {
            position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff;
            border: none; border-radius: 4px; padding: 4px 6px; cursor: pointer; opacity: 0; transition: 0.2s;
        }
        .grid-item:hover .grid-delete { opacity: 1; }
        
        /* --- Controls Bar --- */
        #controls {
            background-color: var(--panel-bg); backdrop-filter: blur(20px);
            padding: 12px 35px; border-radius: 60px;
            display: flex; gap: 20px; align-items: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: 90vw; overflow-x: auto;
        }
        button.ctrl-btn { background: none; border: none; color: #aaa; font-size: 1.2rem; cursor: pointer; width: 42px; height: 42px; border-radius: 50%; transition: 0.2s; flex-shrink: 0; }
        button.ctrl-btn:hover { color: #fff; background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        button.ctrl-btn.active-btn { color: var(--accent); background: rgba(59, 130, 246, 0.2); }
        #btn-sort.active-sort { color: #fff; background: var(--sort-active); box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }
        .filter-warm-active { color: #fff !important; background: rgba(245, 158, 11, 0.2) !important; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        .filter-cool-active { color: #fff !important; background: rgba(6, 182, 212, 0.2) !important; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }
        .slider-group { display: flex; flex-direction: column; align-items: center; width: 140px; flex-shrink: 0; }
        .slider-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px; }
        .slider-label { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;}
        .slider-val { font-size: 0.65rem; color: var(--accent); font-family: monospace; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; appearance: none; }

        /* --- Side Lock --- */
        #lock-wrapper { position: fixed; bottom: 30px; right: 30px; z-index: 300; display: none; }
        #btn-lock { background: rgba(255,255,255,0.05); color: #555; width: 50px; height: 50px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; cursor: pointer; transition: 0.3s; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
        #btn-lock:hover { background: rgba(255,255,255,0.2); color: #fff; }
        #btn-lock.locked { color: var(--accent); border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }

        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 30px; border-radius: 30px; font-size: 1rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 500; backdrop-filter: blur(5px); border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-box">
            <i class="fas fa-exclamation-triangle modal-icon"></i>
            <div class="modal-title" id="modal-title">Confirm Action</div>
            <div class="modal-desc" id="modal-desc">Are you sure?</div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn btn-confirm" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <canvas id="pip-canvas" width="1280" height="720" style="display:none;"></canvas>
    <video id="pip-video" style="display:none;" muted autoplay></video>

    <button id="btn-presets-toggle" onclick="toggleSidebar()"><i class="fas fa-folder"></i></button>
    <div id="preset-bar">
        <div class="sidebar-header">
            <h3>Directory</h3>
            <button class="ctrl-btn" onclick="toggleSidebar()" style="font-size:1rem; width:30px; height:30px;"><i class="fas fa-chevron-left"></i></button>
        </div>
        <div class="path-indicator"><i class="fas fa-hdd"></i> Local Storage</div>
        <input type="text" id="preset-search" placeholder="Search directories..." onkeyup="filterPresets()">
        
        <div id="preset-list"></div>
        
        <div style="margin-top:auto; display:flex; flex-direction:column; gap:10px;">
            <button id="clear-cache-btn" onclick="askClearDB()" style="background:#331111; border-color:#662222; color:#ffaaaa;" class="up-btn">
                <i class="fas fa-trash"></i> Clear Cache
            </button>
            <button id="add-folder-btn" onclick="document.getElementById('folder-input').click()" class="up-btn">
                <i class="fas fa-plus"></i> Import Local
            </button>
        </div>
    </div>

    <button id="btn-home" onclick="goHome()" title="Back to Main Menu"><i class="fas fa-home"></i></button>

    <div id="upload-zone">
        <div class="upload-content">
            <i class="fas fa-layer-group main-icon"></i>
            <h2>Sequence Studio</h2>
            <div class="upload-options">
                <button class="up-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-images"></i> Select Images
                </button>
                <button class="up-btn" onclick="document.getElementById('folder-input').click()">
                    <i class="fas fa-folder-open"></i> Select Folder (picture_set)
                </button>
            </div>
            <p style="color:#555; margin-top: 15px; font-size: 0.9rem;">Images imported here will be saved to your browser automatically.</p>
        </div>

        <div id="landing-grid-container">
            <div id="landing-header">
                <i class="fas fa-network-wired"></i> <span>Detected Albums</span>
            </div>
            <div id="landing-grid">
                <p id="scan-status" style="color:#444; font-size:0.9rem;">Checking saved data...</p>
            </div>
        </div>

        <input type="file" id="file-input" accept="image/*" multiple style="display:none">
        <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none">
    </div>

    <div id="viewer">
        <img id="img-back" class="frame-display" src="">
        <img id="img-front" class="frame-display" src="">
    </div>
    
    <div id="lock-wrapper">
        <button id="btn-lock" onclick="toggleLock()" title="Lock/Unlock Menu"><i class="fas fa-unlock"></i></button>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="filmstrip"></div>

        <div id="controls">
            <button class="ctrl-btn" id="btn-play" onclick="togglePlay()"><i class="fas fa-pause"></i></button>
            <div style="width:1px; height:20px; background:#444;"></div>
            
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Duration</span>
                    <span class="slider-val" id="speed-val">3.0s</span>
                </div>
                <input type="range" id="speed-slider" min="100" max="10000" step="100" value="3000">
            </div>

            <div style="width:1px; height:20px; background:#444;"></div>

            <button class="ctrl-btn" id="btn-effect" onclick="cycleEffect()" title="Transition Effect"><i class="fas fa-magic"></i></button>
            <div style="width:1px; height:20px; background:#444;"></div>

            <button class="ctrl-btn" id="btn-filter" onclick="cycleFilter()" title="Color Theme Filter">
                <i class="fas fa-temperature-high"></i>
            </button>
            <div style="width:1px; height:20px; background:#444;"></div>

            <button class="ctrl-btn" onclick="togglePiP()" title="Picture-in-Picture Mode"><i class="fas fa-external-link-alt"></i></button>
            
            <button class="ctrl-btn" onclick="downloadCurrent()" title="Save Current Frame"><i class="fas fa-download"></i></button>
            <button class="ctrl-btn" onclick="downloadAll()" title="Save All in Playlist" style="font-size: 1rem;"><i class="fas fa-file-export"></i></button>
            <div style="width:1px; height:20px; background:#444;"></div>
            
            <button class="ctrl-btn" id="btn-sort" onclick="toggleSort()" title="Toggle Sort">
                <i class="fas fa-filter"></i>
            </button>
            <div style="width:1px; height:20px; background:#444;"></div>
            
            <button class="ctrl-btn" onclick="openGrid()" title="Open Inventory"><i class="fas fa-th"></i></button>
            <div style="width:1px; height:20px; background:#444;"></div>

            <button class="ctrl-btn" onclick="addMoreFrames()" title="Add Images"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="grid-view">
        <div id="grid-header">
            <span>Inventory</span>
            <button class="ctrl-btn" onclick="closeGrid()"><i class="fas fa-times"></i></button>
        </div>
        <div id="grid-content"></div>
    </div>

    <div id="toast"></div>
    <canvas id="analysis-canvas" style="display:none;"></canvas>

    <script>
        // --- State ---
        let presets = []; 
        let currentPresetIndex = -1;
        let frames = []; 
        let currentFrameIndex = 0;
        let isPlaying = false;
        let isLocked = false;
        let isColorSort = false; 
        let isPiPActive = false;
        const effects = ['none', 'crossfade', 'blur', 'zoom'];
        let currentEffectIndex = 2; 
        const filters = ['none', 'warm', 'cool'];
        let currentFilterIndex = 0;
        let playInterval = null;
        let idleTimer = null;
        let dragSrcIndex = null;
        
        // --- DB State ---
        let db;
        const DB_NAME = "ImmersivePlayerDB";
        const DB_VERSION = 1;
        const STORE_NAME = "images";

        const el = {
            uploadZone: document.getElementById('upload-zone'),
            fileInput: document.getElementById('file-input'),
            folderInput: document.getElementById('folder-input'),
            viewer: document.getElementById('viewer'),
            imgFront: document.getElementById('img-front'),
            imgBack: document.getElementById('img-back'),
            uiLayer: document.getElementById('ui-layer'),
            filmstrip: document.getElementById('filmstrip'),
            gridView: document.getElementById('grid-view'),
            gridContent: document.getElementById('grid-content'),
            playBtn: document.getElementById('btn-play'),
            effectBtn: document.getElementById('btn-effect'),
            filterBtn: document.getElementById('btn-filter'),
            sortBtn: document.getElementById('btn-sort'),
            speedSlider: document.getElementById('speed-slider'),
            speedVal: document.getElementById('speed-val'),
            lockBtn: document.getElementById('btn-lock'),
            lockWrapper: document.getElementById('lock-wrapper'),
            toast: document.getElementById('toast'),
            canvas: document.getElementById('analysis-canvas'),
            presetBar: document.getElementById('preset-bar'),
            presetList: document.getElementById('preset-list'),
            presetToggle: document.getElementById('btn-presets-toggle'),
            presetSearch: document.getElementById('preset-search'),
            landingGrid: document.getElementById('landing-grid'),
            scanStatus: document.getElementById('scan-status'),
            homeBtn: document.getElementById('btn-home'),
            pipCanvas: document.getElementById('pip-canvas'),
            pipVideo: document.getElementById('pip-video'),
            // Modal Elements
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalDesc: document.getElementById('modal-desc'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn')
        };

        const ctx = el.canvas.getContext('2d', { willReadFrequently: true });
        const pipCtx = el.pipCanvas.getContext('2d');
        const FILTER_WARM = "sepia(0.4) saturate(1.5) hue-rotate(-30deg) contrast(1.1)";
        const FILTER_COOL = "sepia(0.3) saturate(1.2) hue-rotate(170deg) brightness(1.1)";

        // --- 1. MODAL SYSTEM ---
        function showConfirm(title, msg, onYes) {
            el.modalTitle.innerText = title;
            el.modalDesc.innerText = msg;
            
            // Clean old event listener to prevent multiple firings
            const newBtn = el.modalConfirmBtn.cloneNode(true);
            el.modalConfirmBtn.parentNode.replaceChild(newBtn, el.modalConfirmBtn);
            el.modalConfirmBtn = newBtn; // Update reference

            el.modalConfirmBtn.onclick = () => {
                onYes();
                closeModal();
            };
            
            el.modalOverlay.style.display = "flex";
            setTimeout(() => el.modalOverlay.classList.add('active'), 10);
        }

        function closeModal() {
            el.modalOverlay.classList.remove('active');
            setTimeout(() => el.modalOverlay.style.display = "none", 300);
        }

        // --- 2. INDEXED DB HANDLING ---
        
        window.onload = function() {
            initDB();
        };

        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (e) => console.error("DB Error", e);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    // keyPath: id, indexes: groupName
                    const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    store.createIndex("groupName", "groupName", { unique: false });
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                loadFromDB();
            };
        }

        function loadFromDB() {
            if (!db) return;
            el.scanStatus.innerText = "Loading saved albums...";
            const transaction = db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            
            request.onsuccess = () => {
                const items = request.result;
                if (items.length > 0) {
                    processDBItems(items);
                    el.scanStatus.innerText = ""; // Clear text
                } else {
                    el.scanStatus.innerText = "No saved albums found. Import a folder to start.";
                }
            };
        }

        function askClearDB() {
            showConfirm("Delete Everything?", "This will permanently delete all saved images from this website.", () => {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const req = store.clear();
                req.onsuccess = () => {
                    showToast("Cache Cleared");
                    setTimeout(() => location.reload(), 500);
                };
            });
        }

        function saveToDB(item) {
            if (!db) return;
            const transaction = db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            store.put(item);
        }

        function processDBItems(items) {
            const grouped = {};
            items.forEach(item => {
                item.src = URL.createObjectURL(item.blob);
                if (!grouped[item.groupName]) grouped[item.groupName] = [];
                grouped[item.groupName].push(item);
            });
            Object.keys(grouped).forEach(gName => {
                createPreset(gName, grouped[gName]);
            });
        }

        // --- NEW DELETE FUNCTIONS (USING MODAL) ---
        function deleteAlbum(name) {
            showConfirm("Delete Album?", `Delete "${name}"? This cannot be undone.`, () => {
                // 1. Remove from Memory
                presets = presets.filter(p => p.name !== name);
                renderPresetList(el.presetSearch.value);
                renderLandingGrid();
                
                // 2. Remove from DB
                if(!db) return;
                const tx = db.transaction([STORE_NAME], "readwrite");
                const store = tx.objectStore(STORE_NAME);
                const index = store.index("groupName");
                const req = index.getAllKeys(IDBKeyRange.only(name));
                
                req.onsuccess = () => {
                    req.result.forEach(key => {
                        store.delete(key);
                    });
                    showToast(`Album "${name}" Deleted`);
                };
            });
        }

        // --- 3. Global Events ---
        function resetIdle() {
            if (frames.length === 0 || isLocked || el.gridView.style.display === 'flex' || el.uploadZone.style.display !== 'none') {
                if(isLocked) el.uiLayer.classList.add('hidden');
                return;
            }
            el.uiLayer.classList.remove('hidden');
            el.homeBtn.style.display = 'flex';
            el.lockWrapper.style.opacity = '1';
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                el.uiLayer.classList.add('hidden');
                el.homeBtn.style.display = 'none';
                el.lockWrapper.style.opacity = '0.2';
            }, 3000);
        }
        window.addEventListener('mousemove', resetIdle);
        window.addEventListener('click', (e) => { 
            if(el.presetBar.contains(e.target) || el.presetToggle.contains(e.target)) return;
            if(document.getElementById('modal-overlay').contains(e.target)) return; // Don't trigger idle on modal
            if(!isLocked || el.lockBtn.contains(e.target)) resetIdle(); 
        });
        
        function toggleLock() {
            isLocked = !isLocked;
            el.lockBtn.innerHTML = isLocked ? '<i class="fas fa-lock"></i>' : '<i class="fas fa-unlock"></i>';
            el.lockBtn.classList.toggle('locked', isLocked);
            el.uiLayer.classList.toggle('hidden', isLocked);
            showToast(isLocked ? "Interface Locked" : "Interface Unlocked");
        }

        function toggleSidebar() {
            el.presetBar.classList.toggle('open');
        }

        function goHome() {
            isPlaying = false;
            clearInterval(playInterval);
            el.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            // UI Switch
            el.viewer.style.display = 'none';
            el.uiLayer.classList.add('hidden');
            el.homeBtn.style.display = 'none';
            el.lockWrapper.style.display = 'none';
            el.gridView.style.display = 'none';
            
            // Show Home
            el.uploadZone.classList.remove('hidden');
            el.uploadZone.style.display = 'flex';
        }

        // --- 4. Picture-in-Picture Logic (FIXED: Wait for Metadata) ---
        async function togglePiP() {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
                isPiPActive = false;
            } else {
                try {
                    renderPiP();
                    if (el.pipVideo.srcObject === null) {
                        const stream = el.pipCanvas.captureStream(25);
                        el.pipVideo.srcObject = stream;
                    }
                    
                    // KEY FIX: Wait for metadata
                    if (el.pipVideo.readyState === 0) {
                        await new Promise(resolve => {
                            el.pipVideo.onloadedmetadata = resolve;
                        });
                    }

                    await el.pipVideo.play();
                    await el.pipVideo.requestPictureInPicture();
                    isPiPActive = true;
                    showToast("Picture-in-Picture Active");
                } catch (error) {
                    console.error(error);
                    showToast("PiP Failed: " + error.message);
                }
            }
        }

        function renderPiP() {
            if(frames.length === 0) return;
            const frame = frames[currentFrameIndex];
            const img = new Image();
            img.onload = () => {
                const cw = el.pipCanvas.width;
                const ch = el.pipCanvas.height;
                pipCtx.fillStyle = "#000";
                pipCtx.fillRect(0, 0, cw, ch);
                
                const imgAspect = img.width / img.height;
                const canvasAspect = cw / ch;
                let dw, dh, dx, dy;
                
                if(imgAspect > canvasAspect) {
                    dw = cw; dh = cw / imgAspect; dx = 0; dy = (ch - dh) / 2;
                } else {
                    dh = ch; dw = ch * imgAspect; dx = (cw - dw) / 2; dy = 0;
                }
                pipCtx.drawImage(img, dx, dy, dw, dh);
            };
            img.src = frame.src;
        }

        // --- 5. File Handling & Saving ---
        function downloadCurrent() {
            if(frames.length === 0) return;
            const frame = frames[currentFrameIndex];
            const a = document.createElement('a');
            a.href = frame.src;
            a.download = frame.name || `image_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("Downloading current frame...");
        }

        function downloadAll() {
            if(frames.length === 0) return;
            showToast(`Downloading ${frames.length} files... Allow popups.`);
            
            let i = 0;
            const interval = setInterval(() => {
                if(i >= frames.length) {
                    clearInterval(interval);
                    return;
                }
                const frame = frames[i];
                const a = document.createElement('a');
                a.href = frame.src;
                a.download = frame.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                i++;
            }, 200); 
        }

        document.addEventListener('paste', e => handleFiles(e.clipboardData.files));
        el.fileInput.addEventListener('change', e => handleFiles(e.target.files));
        
        el.folderInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;
            handleFiles(files, null, true);
        });

        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => { 
            e.preventDefault(); 
            const items = e.dataTransfer.items;
            if (items && items[0] && items[0].webkitGetAsEntry && items[0].webkitGetAsEntry().isDirectory) {
                handleFiles(e.dataTransfer.files, null, true);
            } else {
                handleFiles(e.dataTransfer.files); 
            }
        });
        
        function addMoreFrames() { el.fileInput.click(); }

        function handleFiles(fileList, presetName = null, isFolderImport = false) {
            if(!fileList || fileList.length === 0) return;
            const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
            if(files.length === 0) return;

            let loaded = 0;
            const folderGroups = {}; 
            const singleFrames = [];

            showToast(`Processing ${files.length} images...`);

            files.forEach(file => {
                let groupName = "Imported";
                if (isFolderImport && file.webkitRelativePath) {
                    const pathParts = file.webkitRelativePath.split('/');
                    if (pathParts.length >= 2) {
                        groupName = pathParts[pathParts.length - 2];
                    }
                } else if (presetName) {
                    groupName = presetName;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const hue = extractHue(img);
                        let temp = 'neutral';
                        if (hue < 60 || hue > 300) temp = 'warm';
                        else if (hue > 150 && hue < 270) temp = 'cool';

                        const frameData = {
                            id: Date.now() + Math.random(),
                            blob: file, 
                            name: file.name,
                            hue: hue,
                            temp: temp,
                            groupName: groupName,
                            src: e.target.result
                        };

                        saveToDB({
                            id: frameData.id,
                            blob: file,
                            name: file.name,
                            hue: hue,
                            temp: temp,
                            groupName: groupName
                        });

                        if (isFolderImport) {
                            if (!folderGroups[groupName]) folderGroups[groupName] = [];
                            folderGroups[groupName].push(frameData);
                        } else {
                            singleFrames.push(frameData);
                        }

                        loaded++;
                        if (loaded === files.length) {
                            if (isFolderImport) {
                                Object.keys(folderGroups).forEach(gName => {
                                    createPreset(gName, folderGroups[gName]);
                                });
                                showToast(`Imported & Saved ${Object.keys(folderGroups).length} albums.`);
                            } else {
                                if (presetName) {
                                    createPreset(presetName, singleFrames);
                                } else {
                                    frames = frames.concat(singleFrames);
                                    applyCurrentSort(); 
                                    onFramesUpdated();
                                }
                            }
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- 6. Visual Preset Logic ---
        function createPreset(name, framesArray) {
            let existing = presets.find(p => p.name === name);
            if (existing) {
                const currentIds = new Set(existing.frames.map(f => f.id));
                framesArray.forEach(f => {
                    if(!currentIds.has(f.id)) existing.frames.push(f);
                });
                existing.frames.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            } else {
                framesArray.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                presets.push({ name: name, frames: framesArray });
            }
            renderPresetList();
            renderLandingGrid(); 
        }

        function generateCardHTML(preset, isSidebar = false) {
            const count = preset.frames.length;
            let gridHTML = '';
            let layoutClass = 'layout-4';

            if (count === 1) {
                layoutClass = 'layout-1';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb" style="object-position: center top;">`;
            } else if (count === 2) {
                layoutClass = 'layout-2';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb"><img src="${preset.frames[1].src}" class="album-thumb">`;
            } else if (count === 3) {
                layoutClass = 'layout-3';
                gridHTML = `<img src="${preset.frames[0].src}" class="album-thumb"><img src="${preset.frames[1].src}" class="album-thumb"><img src="${preset.frames[2].src}" class="album-thumb">`;
            } else {
                for(let i=0; i<4; i++) {
                    if (preset.frames[i]) {
                        if (i === 3 && count > 4) {
                            const remaining = count - 4;
                            gridHTML += `<div class="album-more-wrap"><img src="${preset.frames[i].src}"><div class="album-remaining">+${remaining + 1}</div></div>`;
                        } else {
                            gridHTML += `<img src="${preset.frames[i].src}" class="album-thumb">`;
                        }
                    }
                }
            }

            // Note: onclick="event.stopPropagation(); deleteAlbum(...)" is vital!
            const delBtn = `<button class="album-delete-btn" onclick="event.stopPropagation(); deleteAlbum('${preset.name}')" title="Delete Album"><i class="fas fa-trash-alt"></i></button>`;

            return `
                ${delBtn}
                <div class="album-grid ${layoutClass}">${gridHTML}</div>
                <div class="album-info">
                    <div class="album-name">${preset.name}</div>
                    <div class="album-meta">
                        <span class="album-total-count">TOTAL: ${count}</span>
                    </div>
                </div>
            `;
        }

        function renderPresetList(filter = "") {
            el.presetList.innerHTML = '';
            presets.forEach((preset, index) => {
                if (filter && !preset.name.toLowerCase().includes(filter.toLowerCase())) return;
                const card = document.createElement('div');
                card.className = 'album-card' + (index === currentPresetIndex ? ' active' : '');
                card.innerHTML = generateCardHTML(preset, true);
                card.onclick = () => loadPreset(index);
                el.presetList.appendChild(card);
            });
        }

        function renderLandingGrid() {
            if(!el.landingGrid) return;
            if(presets.length > 0) el.landingGrid.innerHTML = '';
            
            presets.forEach((preset, index) => {
                const card = document.createElement('div');
                card.className = 'landing-card';
                card.innerHTML = generateCardHTML(preset, false);
                card.onclick = () => loadPreset(index);
                el.landingGrid.appendChild(card);
            });
        }
        
        function filterPresets() {
            renderPresetList(el.presetSearch.value);
        }

        function loadPreset(index) {
            currentPresetIndex = index;
            frames = [...presets[index].frames]; 
            applyCurrentSort();
            onFramesUpdated();
            renderPresetList(el.presetSearch.value); 
            el.presetBar.classList.remove('open');
        }

        // --- Standard Logic ---
        function extractHue(img) {
            try {
                el.canvas.width = 30; el.canvas.height = 30;
                ctx.drawImage(img, 0, 0, 30, 30);
                const data = ctx.getImageData(0, 0, 30, 30).data;
                let r=0, g=0, b=0, count=0;
                for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++; }
                r/=255; g/=255; b/=255;
                const max=Math.max(r,g,b), min=Math.min(r,g,b);
                let h=0;
                if(max!==min) {
                    const d=max-min;
                    switch(max) {
                        case r: h=(g-b)/d+(g<b?6:0); break;
                        case g: h=(b-r)/d+2; break;
                        case b: h=(r-g)/d+4; break;
                    }
                    h/=6;
                }
                return h*360;
            } catch(e) { return 0; }
        }

        function onFramesUpdated() {
            el.uploadZone.style.display = 'none'; // Hide menu
            el.viewer.style.display = 'flex';
            el.lockWrapper.style.display = 'block';
            el.homeBtn.style.display = 'flex'; // Show back button
            
            renderFilmstrip();
            if(el.gridView.style.display === 'flex') renderGrid(); 

            if (!isPlaying && frames.length > 0) {
                isPlaying = true;
                currentFrameIndex = 0;
                startLoop();
            }
        }

        function toggleSort() {
            isColorSort = !isColorSort;
            el.sortBtn.classList.toggle('active-sort', isColorSort);
            el.sortBtn.innerHTML = isColorSort ? '<i class="fas fa-palette"></i>' : '<i class="fas fa-font"></i>';
            applyCurrentSort();
            showToast(isColorSort ? "Sorted by Color" : "Sorted by Name");
        }

        function applyCurrentSort() {
            if (isColorSort) {
                frames.sort((a, b) => {
                    const hueGroupA = Math.floor(a.hue / 30);
                    const hueGroupB = Math.floor(b.hue / 30);
                    if (hueGroupA !== hueGroupB) return hueGroupA - hueGroupB;
                    return a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'});
                });
            } else {
                frames.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            }
            currentFrameIndex = 0; 
            updateDisplay(true);
            renderFilmstrip();
            if(el.gridView.style.display === 'flex') renderGrid();
        }

        function openGrid() {
            isPlaying = false; 
            clearInterval(playInterval);
            el.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            el.gridView.style.display = 'flex';
            renderGrid();
        }
        function closeGrid() {
            el.gridView.style.display = 'none';
            renderFilmstrip(); 
            updateDisplay(true);
        }
        function renderGrid() {
            el.gridContent.innerHTML = '';
            frames.forEach((frame, index) => {
                const item = document.createElement('div');
                item.className = 'grid-item' + (index === currentFrameIndex ? ' active' : '');
                item.draggable = true;
                const img = document.createElement('img');
                img.src = frame.src;
                
                const filter = getFilterString(frame);
                if (filter !== "none") img.style.filter = filter;
                
                const del = document.createElement('button');
                del.className = 'grid-delete';
                del.innerHTML = '<i class="fas fa-trash"></i>';
                // UPDATED: Use removeFrame which now handles DB
                del.onclick = (e) => { e.stopPropagation(); removeFrame(index); };
                item.onclick = () => { currentFrameIndex = index; closeGrid(); };
                
                item.addEventListener('dragstart', (e) => { dragSrcIndex = index; e.dataTransfer.effectAllowed = 'move'; });
                item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                item.addEventListener('drop', (e) => {
                    e.stopPropagation();
                    if(dragSrcIndex !== index) {
                        const itm = frames[dragSrcIndex];
                        frames.splice(dragSrcIndex, 1);
                        frames.splice(index, 0, itm);
                        if(currentFrameIndex === dragSrcIndex) currentFrameIndex = index;
                        renderGrid();
                    }
                });
                item.appendChild(img);
                item.appendChild(del);
                el.gridContent.appendChild(item);
            });
        }

        function startLoop() {
            if(playInterval) clearInterval(playInterval);
            if(!isPlaying || frames.length === 0) return;
            const delay = parseInt(el.speedSlider.value);
            playInterval = setInterval(() => {
                currentFrameIndex++;
                if(currentFrameIndex >= frames.length) currentFrameIndex = 0;
                updateDisplay();
                updateFilmstripHighlight();
            }, delay);
        }

        function getFilterString(frame) {
            const mode = filters[currentFilterIndex];
            if (mode === 'warm' && frame.temp !== 'warm') return FILTER_WARM;
            if (mode === 'cool' && frame.temp !== 'cool') return FILTER_COOL;
            return "none";
        }

        function updateDisplay(instant = false) {
            if (frames.length === 0) return;
            const frame = frames[currentFrameIndex];
            
            renderPiP();
            
            const effect = effects[currentEffectIndex];
            const baseFilter = getFilterString(frame);
            
            el.imgBack.src = el.imgFront.src;
            el.imgBack.style.cssText = el.imgFront.style.cssText; 
            el.imgBack.style.transition = 'none';
            el.imgBack.style.opacity = 1;

            el.imgFront.src = frame.src;
            el.imgFront.style.transition = 'none';
            el.imgFront.style.opacity = 0;
            
            if (!instant && effect !== 'none') {
                const speedVal = parseInt(el.speedSlider.value);
                const transTime = Math.min(speedVal * 0.9, 2500);

                if(effect === 'blur') {
                    const blurStr = "blur(15px)";
                    el.imgFront.style.filter = baseFilter !== 'none' ? `${baseFilter} ${blurStr}` : blurStr;
                    el.imgFront.style.transform = 'translate(-50%, -50%) scale(1)';
                } 
                else if(effect === 'zoom') {
                    el.imgFront.style.filter = baseFilter;
                    el.imgFront.style.transform = 'translate(-50%, -50%) scale(1.1)';
                }
                else {
                    el.imgFront.style.filter = baseFilter;
                    el.imgFront.style.transform = 'translate(-50%, -50%) scale(1)';
                }

                void el.imgFront.offsetWidth; 

                el.imgFront.style.transition = `all ${transTime}ms ease`;
                el.imgFront.style.opacity = 1;
                
                if(effect === 'blur') {
                    el.imgFront.style.filter = baseFilter !== 'none' ? `${baseFilter} blur(0px)` : 'blur(0px)';
                } else if(effect === 'zoom') {
                    el.imgFront.style.transform = 'translate(-50%, -50%) scale(1.0)';
                }

            } else {
                el.imgFront.style.transition = 'none';
                el.imgFront.style.opacity = 1;
                el.imgFront.style.transform = 'translate(-50%, -50%) scale(1)';
                el.imgFront.style.filter = baseFilter;
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            el.playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            if(isPlaying) startLoop(); else clearInterval(playInterval);
        }

        function cycleEffect() {
            currentEffectIndex = (currentEffectIndex + 1) % effects.length;
            const names = ['Hard Cut', 'Crossfade', 'Blur', 'Zoom'];
            showToast(`Transition: ${names[currentEffectIndex]}`);
            el.effectBtn.style.color = currentEffectIndex === 0 ? '#aaa' : '#3b82f6';
        }

        function cycleFilter() {
            currentFilterIndex = (currentFilterIndex + 1) % filters.length;
            const mode = filters[currentFilterIndex];
            el.filterBtn.className = 'ctrl-btn';
            if(mode === 'warm') el.filterBtn.classList.add('filter-warm-active');
            if(mode === 'cool') el.filterBtn.classList.add('filter-cool-active');
            showToast(`Filter: ${mode.toUpperCase()}`);
            updateDisplay(true); 
            if(el.gridView.style.display === 'flex') renderGrid(); 
        }

        el.speedSlider.addEventListener('input', () => { 
            const val = (el.speedSlider.value / 1000).toFixed(1);
            el.speedVal.textContent = val + 's';
            if(isPlaying) startLoop(); 
        });

        function renderFilmstrip() {
            el.filmstrip.innerHTML = '';
            frames.forEach((frame, index) => {
                const wrap = document.createElement('div');
                wrap.className = 'thumb-wrap' + (index === currentFrameIndex ? ' active' : '');
                wrap.draggable = true;
                wrap.dataset.index = index;
                const img = document.createElement('img');
                img.src = frame.src;
                
                wrap.onclick = () => { currentFrameIndex = index; updateDisplay(true); updateFilmstripHighlight(); };
                wrap.addEventListener('dragstart', e => { dragSrcIndex = index; e.dataTransfer.effectAllowed = 'move'; });
                wrap.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
                wrap.addEventListener('drop', e => {
                    e.stopPropagation();
                    if (dragSrcIndex !== index) {
                        const item = frames[dragSrcIndex];
                        frames.splice(dragSrcIndex, 1);
                        frames.splice(index, 0, item);
                        if(currentFrameIndex === dragSrcIndex) currentFrameIndex = index;
                        renderFilmstrip(); updateDisplay(true);
                    }
                });
                wrap.appendChild(img);
                el.filmstrip.appendChild(wrap);
            });
        }

        function updateFilmstripHighlight() {
            const thumbs = document.querySelectorAll('.thumb-wrap');
            thumbs.forEach((t, i) => {
                if(i === currentFrameIndex) {
                    t.classList.add('active');
                    t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else t.classList.remove('active');
            });
        }

        // --- UPDATED REMOVE FRAME LOGIC ---
        function removeFrame(index) {
            const frame = frames[index];
            if(!frame) return;

            showConfirm("Delete Image?", "Delete this specific image permanently?", () => {
                // 1. Remove from DB
                if(db) {
                    const tx = db.transaction([STORE_NAME], "readwrite");
                    tx.objectStore(STORE_NAME).delete(frame.id);
                }

                // 2. Remove from Memory (Current Playlist)
                frames.splice(index, 1);
                
                // 3. Remove from Memory (Presets Global List)
                presets.forEach(p => {
                    p.frames = p.frames.filter(f => f.id !== frame.id);
                });
                renderPresetList(el.presetSearch.value); 

                // 4. Update UI
                if(frames.length === 0) {
                    goHome();
                } else {
                    if(currentFrameIndex >= frames.length) currentFrameIndex = 0;
                    renderFilmstrip(); 
                    if(el.gridView.style.display === 'flex') renderGrid();
                    updateDisplay(true);
                }
                showToast("Image Deleted");
            });
        }

        function showToast(msg) {
            el.toast.textContent = msg;
            el.toast.style.opacity = '1';
            setTimeout(() => el.toast.style.opacity = '0', 2000);
        }
    </script>
</body>
</html>